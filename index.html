<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SAE4.02 - Archery XR</title>
  </head>
  <body>
    <!-- Debug Panel -->
    <div id="debug-panel" style="
      position: fixed;
      top: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.8);
      color: #0f0;
      font-family: monospace;
      font-size: 12px;
      padding: 10px;
      border: 2px solid #0f0;
      border-radius: 5px;
      z-index: 9999;
      max-width: 350px;
      line-height: 1.4;
      max-height: 400px;
      overflow-y: auto;
    ">
      <div style="font-weight: bold; margin-bottom: 5px;">üîç DEBUG VR</div>
      <div id="debug-gamepad">Gamepads: --</div>
      <div id="debug-trigger">Trigger: OFF</div>
      <div id="debug-thumbstick">Thumbstick: OFF</div>
      <div id="debug-raycast">Raycast: --</div>
      <div id="debug-targets">Targets: 0</div>
      <div id="debug-fps" style="margin-top: 5px; border-top: 1px solid #0f0; padding-top: 5px;">FPS: --</div>
      <div id="debug-errors" style="margin-top: 5px; border-top: 1px solid #f00; padding-top: 5px; color: #f00;">
        <div style="color: #0f0;">Erreurs:</div>
        <div id="error-list" style="max-height: 150px; overflow-y: auto;"></div>
      </div>
    </div>

    <!-- State management avec aframe-state-component -->
    <a-scene 
      state="score: 0; combo: 0; multiplier: 1.0; gameStarted: false"
      webxr="requiredFeatures: local-floor; optionalFeatures: hit-test,anchors,hand-tracking;"
      game-manager
      combo-system>
      <!-- Assets -->
      <a-assets>
        <a-asset-item id="bow-model" src="/bow.glb"></a-asset-item>
        <a-asset-item id="target-model" src="/target.glb"></a-asset-item>
        <audio id="background-sound" src="/son/song-background.mp3" crossorigin="anonymous" loop></audio>
        <audio id="hit-sound" src="/son/arrow.mp3" crossorigin="anonymous"></audio>
      </a-assets>
      
      <!-- Environnement -->
      <a-entity environment="preset: forest; dressingAmount: 500"></a-entity>
      
      <!-- Lumi√®re -->
      <a-entity light="type: ambient; color: #BBB"></a-entity>
      <a-entity light="type: directional; color: #FFF; intensity: 0.6" position="-0.5 1 1"></a-entity>
      
      <!-- Sol (invisible mais interactif) -->
      <a-plane position="0 0 -4" rotation="-90 0 0" width="50" height="50"
           material="transparent: true; opacity: 0"></a-plane>
           
      <!-- Scene Mesh Handler pour WebXR -->
      <a-entity scene-mesh-handler></a-entity>
      
      <!-- Cible avec physique et comportement -->
      <a-entity 
        id="target-1"
        position="0 1.5 -5" 
        rotation="0 0 0"
        target-behavior="points: 10; hp: 3; movable: false">
        <a-entity gltf-model="#target-model" scale="1 1 1"></a-entity>
      </a-entity>
      
      <!-- Cible mobile -->
      <a-entity 
        id="target-2"
        position="-2 1.5 -6" 
        target-behavior="points: 20; hp: 2; movable: true">
        <a-entity gltf-model="#target-model" scale="1 1 1"></a-entity>
      </a-entity>
      
      <!-- Cam√©ra avec contr√¥les VR -->
      <a-entity id="rig" position="0 1.6 0">
        <a-camera></a-camera>
        <!-- Contr√¥leurs VR avec support hand-tracking -->
        <a-entity 
          id="leftHand" 
          hand-controls="hand: left"
          hand-tracking-controls="hand: left"
          vive-controls="hand: left"
          oculus-touch-controls="hand: left"
          windows-motion-controls="hand: left"
          bow-logic>
          <a-entity gltf-model="#bow-model" scale="0.25 0.25 0.25" rotation="0  90 90" position="0 0 0"></a-entity>
        </a-entity>
        <a-entity 
          id="rightHand" 
          hand-controls="hand: right"
          hand-tracking-controls="hand: right"
          vive-controls="hand: right"
          oculus-touch-controls="hand: right"
          windows-motion-controls="hand: right"></a-entity>
      </a-entity>
      
      <!-- Bouton VR pour entrer en mode immersif -->
      <!-- <a-entity position="0 2 -3" class="interactive" raycaster="objects: .interactive" cursor="rayOrigin: mouse">
        <a-box position="0 0 0" rotation="0 45 0" color="#4CC3D9" 
               animation="property: rotation; to: 0 405 0; loop: true; dur: 10000"></a-box>
        <a-text value="Cliquez pour commencer" position="0 0.6 0" align="center" color="#000" width="4"></a-text>
      </a-entity> -->
      
      <!-- Texte d'instructions -->
      <!-- <a-text value="SAE 4.02 - Archery XR\nAppuyez sur VR pour mode immersif" 
              position="0 2.5 -4" align="center" color="#FFF" width="6"></a-text> -->
    </a-scene>


















    <script type="module" src="/src/main.js"></script>
    
    <!-- Script de d√©bogage FPS et Erreurs -->
    <script>
      let frameCount = 0
      let lastTime = Date.now()
      const errorLog = []
      
      // Capture les erreurs avec num√©ro de ligne
      window.addEventListener('error', (e) => {
        const line = e.lineno || '?'
        const col = e.colno || '?'
        const msg = `‚ùå Line ${line}:${col} - ${e.message}`
        errorLog.unshift(msg)
        if (errorLog.length > 15) errorLog.pop()
        updateErrorDisplay()
        console.error(`[${line}:${col}]`, e.message, e)
      })
      
      // Capture les erreurs de promesse
      window.addEventListener('unhandledrejection', (e) => {
        const msg = `‚ùå Promise: ${e.reason}`
        errorLog.unshift(msg)
        if (errorLog.length > 15) errorLog.pop()
        updateErrorDisplay()
        console.error('Unhandled rejection:', e)
      })
      
      // Monkey-patch console.error pour capturer aussi les erreurs logg√©es
      const originalError = console.error
      console.error = function(...args) {
        const msg = `‚ùå ${args.join(' ')}`
        errorLog.unshift(msg)
        if (errorLog.length > 15) errorLog.pop()
        updateErrorDisplay()
        originalError.apply(console, args)
      }
      
      function updateErrorDisplay() {
        const errorList = document.getElementById('error-list')
        if (errorList) {
          errorList.innerHTML = errorLog.map(e => `<div>${e}</div>`).join('')
        }
      }
      
      function updateDebug() {
        frameCount++
        const now = Date.now()
        const elapsed = now - lastTime
        
        if (elapsed >= 1000) {
          const fps = Math.round((frameCount * 1000) / elapsed)
          const fpsEl = document.getElementById('debug-fps')
          if (fpsEl) fpsEl.textContent = `FPS: ${fps}`
          frameCount = 0
          lastTime = now
        }
        
        requestAnimationFrame(updateDebug)
      }
      
      updateDebug()
    </script>
  </body>
</html>
